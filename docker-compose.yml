services:
  migrator:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    networks:
      - tg_bot
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
    - .env
    command: >
      sh -lc '
        echo "Waiting for Postgres...";
        until pg_isready -h "$MIGRATOR_PGHOST" -p "$MIGRATOR_PGPORT" -U "$MIGRATOR_PGUSER" -d "$MIGRATOR_PGDATABASE"; do
          sleep 1;
        done;
        echo "Postgres is ready. Running migrations...";
        alembic upgrade head
      '
    volumes:
      - ./app:/aiogram/app:rw
    restart: "no"

  app:
    build:
      context: .
      dockerfile: ./app/Dockerfile
    container_name: aiogram_app
    working_dir: /aiogram
    command: python -m app
    depends_on:
      - migrator
    networks:
      - tg_bot
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - .env
    volumes:
      - ./app:/aiogram/app:rw
      - ./alembic.ini:/aiogram/alembic.ini:ro
    restart: unless-stopped
    tty: true
  
networks:
  tg_bot:
    driver: bridge
    ipam:
      config:
       - subnet: 172.30.10.0/24
